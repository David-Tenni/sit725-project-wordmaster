<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - WordMaster</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <link rel="stylesheet" href="wordmaster.css">
</head>
<body>
    <div class="purple-blob"></div>
     <div class="container">
      <div class="brand-title">
        <div class="logo-section">
            <div class="logo">
                <img src="img/logo.png" alt="WordMaster Logo" class="logo-svg" />
            </div>
        </div>
        <h4>WordMaster</h4>
    </div>
              <!--navigation bar-->
    <nav class="navbar">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="/profile.html" id="profile-menu">Profile</a></li>
          <li><a href="leaderboard.html">Leaderboard</a></li>
          <li><a href="settings.html" class="active" id="settings-menu">Settings</a></li>
        </ul>
      </nav>
  <!-- Collapsible Reset Password Section -->
  <div class="container">
    <div class="welcome-card">
      <ul class="collapsible">
        <li>
          <div class="collapsible-header">Reset Password</div>
          <div class="collapsible-body">
            <form id="reset-password-form">
              <div class="input-field">
                <input type="password" id="new-password" placeholder="New Password" required>
              </div>
              <button type="submit" class="waves-effect waves-light btn btn-custom play-btn">Update Password</button>
            </form>
            <p id="reset-password-error" class="error-message"></p>
            <p id="reset-password-success" class="success-message"></p>
          </div>
        </li>
      </ul>
   <!-- Logout and Delete Account Buttons -->
   <div class="action-buttons">
    <button id="delete-account-button" class="waves-effect waves-light">Delete Account</button>
    <button id="logout-button" class="waves-effect waves-light">Logout</button>
  </div>
  <p id="delete-account-error" class="error-message"></p>
  <p id="delete-account-success" class="success-message"></p>
</div>
<script>
  //collapse reset section
  $(document).ready(function() {
     $('.collapsible').collapsible();
   });
   
   $('#reset-password-form').on('submit', function(e) {
     e.preventDefault();
     const newPassword = $('#new-password').val();
     const accessToken = localStorage.getItem('accessToken');


     if (!accessToken) {
       $('#reset-password-error').text('You are not logged in.');
       return;
     }


     $.ajax({
       url: '/api/user/password',
       method: 'PATCH',
       contentType: 'application/json',
       headers: {
         'Authorization': accessToken
       },
       data: JSON.stringify({ password: newPassword }),
       success: function(response) {
         $('#reset-password-success').text('Password updated successfully.');
         $('#reset-password-error').text('');
       },
       error: function(xhr) {
         if (xhr.status === 400) {
           $('#reset-password-error').text('Password is required.');
         } else if (xhr.status === 401) {
           $('#reset-password-error').text('Invalid or expired token. Please log in again.');
         } else {
           $('#reset-password-error').text('An error occurred. Please try again.');
         }
         $('#reset-password-success').text('');
       }
     });
   });
  $('#logout-button').on('click', function() {
    //clear tokens and user data from localStorage
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('user');
    //redirect to mainMenu.html
    window.location.href = '/mainMenu.html';
 });
 
 //delete account
 $('#delete-account-button').on('click', function() {
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
        $('#delete-account-error').text('You are not logged in.');
        return;
    }
    //delete confirmation
    if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        return;
    }

     $.ajax({
       url: '/api/user',
       method: 'DELETE',
       headers: {
         'Authorization': accessToken
       },
       success: function(response) {
         localStorage.removeItem('accessToken');
         localStorage.removeItem('refreshToken');
         localStorage.removeItem('isLoggedIn');
         localStorage.removeItem('user');

         //success message and redirect to mainMenu.html
         $('#delete-account-success').text('Account deleted successfully.');
         setTimeout(() => {
           window.location.href = '/mainMenu.html';
         }, 2000);
       },
       error: function(xhr) {
         if (xhr.status === 401) {
           $('#delete-account-error').text('Invalid or expired token. Please log in again.');
         } else {
           $('#delete-account-error').text('An error occurred. Please try again.');
         }
       }
     });
   });

  </script>
</body>
</html>
